<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#f4a63a" />
  <title>å‡ºéŠç†Šç™¾å²³</title>

  <style>
    :root{
      --bg:#ffeec9;
      --panel:#fff7e6;
      --panel2:#fffdf7;
      --line:#e1b676;
      --line2:#f5d3a6;
      --accent:#f4a63a;
      --accent2:#ff7d4d;
      --text:#4b3044;
      --muted:#7b5d4b;
      --shadow: 0 6px 18px rgba(0,0,0,0.18);
      --radius:18px;
      --radius2:16px;
      --maxw:480px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      background: #ffb54b;
      font-family: "Noto Sans TC", -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text);
    }
    .app{
      max-width: var(--maxw);
      min-height: 100vh;
      margin: 0 auto;
      background: var(--bg);
      padding: 10px 10px 90px;
    }

    /* Header */
    .topbar{
      background: linear-gradient(180deg, #fff2d6, #ffe7bf);
      border: 2px solid var(--line2);
      border-radius: 20px;
      padding: 10px;
      box-shadow: var(--shadow);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .avatar{
      width:54px; height:54px;
      border-radius: 16px;
      border: 2px solid #f0c58f;
      background:#fff;
      overflow:hidden;
      flex:0 0 auto;
    }
    .avatar img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
    }
    .topinfo{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .pill-row{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      background:#fff;
      border:1.5px solid #f1cfa4;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
      max-width: 100%;
    }
    .pill strong{ color: var(--text); }
    .pill .dot{ width:8px; height:8px; border-radius:99px; background: #66c56b; display:inline-block; }

    /* Progress card */
    .card{
      background: var(--panel);
      border: 2px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      margin-top: 10px;
    }
    .card h3{
      margin:0 0 8px;
      font-size: 14px;
      letter-spacing: .5px;
    }
    .progress-wrap{
      background:#fff;
      border: 1.5px solid #f1cfa4;
      border-radius: 999px;
      overflow:hidden;
      height: 12px;
    }
    .progress-bar{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ff7d4d, #f4a63a);
      transition: width .3s ease;
    }
    .small{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.4;
    }

    /* Speech bubble */
    .bubble{
      margin-top: 10px;
      background: #fff;
      border: 2px solid #f0c58f;
      border-radius: 18px;
      padding: 10px 12px;
      position: relative;
      box-shadow: 0 4px 14px rgba(0,0,0,0.12);
    }
    .bubble:before{
      content:"";
      position:absolute;
      left: 18px; top: -10px;
      width: 0; height:0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 10px solid #f0c58f;
    }
    .bubble:after{
      content:"";
      position:absolute;
      left: 18px; top: -8px;
      width: 0; height:0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 10px solid #fff;
    }
    .bubble .hint{
      font-size: 12px;
      color: #8a6f5a;
      margin-top: 6px;
    }

    /* Route selection */
    .route-title{
      font-weight: 900;
      margin: 0 0 10px;
      font-size: 18px;
      letter-spacing: .5px;
    }
    .checkbox-row{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom: 10px;
      color: var(--muted);
      font-size: 13px;
    }
    .checkbox-row input{ transform: scale(1.2); }

    .route-card{
      display:flex;
      gap:10px;
      align-items:center;
      background: #fff;
      border: 2px solid #f1cfa4;
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 10px;
      cursor:pointer;
      user-select:none;
    }
    .route-ico{
      width:46px; height:46px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 22px;
      border: 2px solid #f1cfa4;
      background: #fff7e6;
      flex:0 0 auto;
    }
    .route-main{ flex:1; min-width:0; }
    .route-main .t{ font-weight: 900; font-size: 16px; margin-bottom: 4px; }
    .route-main .d{ font-size: 12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .route-arrow{ color:#b58a64; font-size: 18px; }

    /* Buttons */
    .btn-row{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .btn{
      flex:1;
      border:none;
      border-radius: 16px;
      padding: 12px 12px;
      font-weight: 900;
      color:#fff;
      background: linear-gradient(90deg, #ff7d4d, #f4a63a);
      box-shadow: 0 8px 18px rgba(0,0,0,0.14);
      cursor:pointer;
    }
    .btn-ghost{
      flex:1;
      border-radius: 16px;
      padding: 12px 12px;
      font-weight: 900;
      cursor:pointer;
      border: 2px solid #f1cfa4;
      background:#fff;
      color: #7b5d4b;
      box-shadow: 0 6px 14px rgba(0,0,0,0.10);
    }

    .ig-row{
      display:flex; gap:8px; align-items:center;
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
    }
    .ig-link{
      color:#b35a00;
      text-decoration: underline;
      font-weight: 900;
    }

    /* Lists */
    .list{
      margin-top: 10px;
    }
    .mount-item{
      background:#fff;
      border: 2px solid #f1cfa4;
      border-radius: 16px;
      padding: 10px 12px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .mount-item .left{
      display:flex;
      gap:10px;
      align-items:center;
      flex:1;
      min-width:0;
    }
    .mount-item .name{
      font-weight: 900;
      font-size: 16px;
      margin-bottom: 4px;
    }
    .mount-item .meta{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tag{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1.5px solid #f1cfa4;
      background:#fff7e6;
      color:#7b5d4b;
      flex:0 0 auto;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .done{
      display:flex; gap:6px; align-items:center;
      font-size: 13px; font-weight: 900;
      color:#2c7a3f;
    }
    .done input{ transform: scale(1.3); }

    /* Bottom nav */
    .bottom-nav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      display:flex;
      justify-content:center;
      padding: 10px;
      background: rgba(255, 245, 225, 0.85);
      backdrop-filter: blur(8px);
      border-top: 1px solid rgba(0,0,0,0.06);
    }
    .nav-inner{
      max-width: var(--maxw);
      width: 100%;
      background:#fff;
      border: 2px solid #f1cfa4;
      border-radius: 18px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.12);
      padding: 8px;
      display:flex;
      gap:8px;
    }
    .navbtn{
      flex:1;
      border:none;
      background: transparent;
      border-radius: 14px;
      padding: 10px 8px;
      cursor:pointer;
      color:#7b5d4b;
      font-weight: 900;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      font-size: 12px;
    }
    .navbtn .ico{ font-size: 18px; }
    .navbtn.active{
      background: #fff7e6;
      border: 2px solid #f1cfa4;
    }

    /* Modals */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 999;
    }
    .modal{
      width: min(var(--maxw), 100%);
      background: #fff;
      border-radius: 20px;
      border: 2px solid #f1cfa4;
      box-shadow: 0 18px 40px rgba(0,0,0,0.22);
      overflow:hidden;
    }
    .modal-head{
      background: #fff7e6;
      border-bottom: 1px dashed #f1cfa4;
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal-head .title{
      font-weight: 900;
      color:#6b4c39;
    }
    .modal-head .close{
      border: 2px solid #f1cfa4;
      background:#fff;
      border-radius: 14px;
      padding: 6px 10px;
      font-weight: 900;
      cursor:pointer;
      color:#7b5d4b;
    }
    .modal-body{
      padding: 12px;
      background: #fffdf7;
    }

    /* Export cards (for screenshot) */
    .export-card{
      background: #fff7e6;
      border: 2px solid #f1cfa4;
      border-radius: 18px;
      padding: 12px;
    }
    .export-card h2{
      margin: 0 0 8px;
      font-size: 20px;
    }
    .export-card .line{
      height:1px;
      background: linear-gradient(90deg, transparent, #f1cfa4, transparent);
      margin: 10px 0;
    }
    .export-card .big{
      font-size: 18px;
      font-weight: 900;
    }
    .export-card .quote{
      margin-top: 8px;
      font-size: 13px;
      line-height: 1.6;
      color:#6b4c39;
    }
    .export-card .goal{
      margin-top: 8px;
      font-size: 13px;
      color:#6b4c39;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight: 900;
    }
    .export-card .ig{
      margin-top: 10px;
      font-size: 12px;
      color:#7b5d4b;
      display:flex;
      align-items:center;
      gap:8px;
    }

    /* History list in modal */
    .history-box{
      max-height: 280px;
      overflow:auto;
      padding-right: 6px;
    }
    .h-item{
      background:#fff;
      border: 1.5px solid #f1cfa4;
      border-radius: 14px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .h-item .ht{
      font-weight: 900;
      margin-bottom: 6px;
    }
    .h-item .hs{
      font-size: 12px;
      color:#7b5d4b;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    /* Sections */
    .section{ display:none; }
    .section.active{ display:block; }

    /* Small toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 110px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      font-size: 13px;
      display:none;
      z-index: 1000;
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- ===== Home / æŠ½å±± ===== -->
    <section id="sec-draw" class="section active">

      <div class="topbar">
        <div class="avatar" title="æ‘é•·ç†Šç†Š">
          <!-- ä½ å¯ä»¥æ›æˆä½ è‡ªå·±çš„ç†Šç†Šé ­åƒ -->
          <img src="https://images.unsplash.com/photo-1543852786-1cf6624b9987?auto=format&fit=crop&w=200&q=60" alt="ç†Šç†Š">
        </div>

        <div class="topinfo">
          <div class="pill-row">
            <div class="pill"><span>â›°ï¸</span><strong id="todayStatus">ä»Šæ—¥ç‹€æ…‹ï¼šæº–å‚™å‡ºç™¼</strong></div>
            <div class="pill"><span class="dot"></span><strong id="progressText">0 / 100</strong></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>ç™»å±±é€²åº¦ <span style="float:right" id="progressSmall">0 / 100</span></h3>
        <div class="progress-wrap" aria-label="progress">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="small">æ¯å¾æœ 10 åº§æœƒè§£é–ç¥è³€å¡ ğŸ‰</div>
      </div>

      <div class="bubble" id="bubbleBox">
        <div id="bubbleText">ğŸ» ç†Šç†Šèªªï¼šæŠŠå®‰å…¨æ”¾ç¬¬ä¸€åï¼Œä½ å°±å·²ç¶“æ˜¯é«˜æ‰‹äº†ã€‚</div>
        <div class="hint">æç¤ºï¼šé•·æŒ‰å¯è¤‡è£½å°èª</div>
      </div>

      <div class="card">
        <div class="route-title">ä»Šå¤©æƒ³æŒ‘æˆ°å“ªç¨®è·¯ç·šï¼Ÿ</div>

        <label class="checkbox-row">
          <input type="checkbox" id="collectMode" checked />
          é›†å¡æ¨¡å¼ï¼ˆå¾æœå¾Œä¸å†æŠ½ï¼‰
        </label>

        <div class="route-card" id="routeBeginner">
          <div class="route-ico">ğŸ’</div>
          <div class="route-main">
            <div class="t">æ–°æ‰‹ç™¾å²³</div>
            <div class="d">è¦ªæ°‘è·¯ç·šï¼Œæ…¢æ…¢èµ°ä¹Ÿå¾ˆæ£’</div>
          </div>
          <div class="route-arrow">â€º</div>
        </div>

        <div class="route-card" id="routeIntermediate">
          <div class="route-ico">ğŸ¥¾</div>
          <div class="route-main">
            <div class="t">é€²éšæŒ‘æˆ°</div>
            <div class="d">é«”èƒ½èˆ‡æº–å‚™æ›´é‡è¦</div>
          </div>
          <div class="route-arrow">â€º</div>
        </div>

        <div class="route-card" id="routeAdvanced">
          <div class="route-ico">âš ï¸</div>
          <div class="route-main">
            <div class="t">ç†Šç†Šæé†’ï¼šéœ€å¸¶éšŠ</div>
            <div class="d">æ›éšªï¼è¿·é€”é¢¨éšªè¼ƒé«˜</div>
          </div>
          <div class="route-arrow">â€º</div>
        </div>

        <div class="ig-row">
          ğŸ“· IG
          <a class="ig-link" href="https://instagram.com/luckygbear" target="_blank" rel="noopener">@luckygbear</a>
        </div>

        <div class="btn-row">
          <button id="btnHistory" class="btn-ghost">ğŸ“œ æŠ½å¡ç´€éŒ„</button>
          <button id="btnExport" class="btn">ğŸ“¤ åŒ¯å‡º IG ç¥è³€åœ–</button>
        </div>

        <div class="btn-row">
          <button id="btnExportCard" class="btn-ghost">ğŸ–¼ï¸ åŒ¯å‡ºæŠ½å¡ IG åœ–</button>
          <button id="btnDrawNow" class="btn">ğŸ´ ç«‹å³æŠ½ä¸€å¼µ</button>
        </div>
      </div>

      <div class="card" id="drawResultCard" style="display:none;">
        <h3>ğŸ´ æŠ½åˆ°çš„å±±</h3>
        <div id="drawResultText" class="small" style="font-size:13px;"></div>
        <div class="small" style="margin-top:10px;">
          âœ… ä½ å¯ä»¥å»ã€Œç™¾å²³ã€é é¢å‹¾é¸å·²å¾æœï¼Œé€²åº¦æœƒæ›´æ–°ã€‚
        </div>
      </div>
    </section>

    <!-- ===== ç™¾å²³ list ===== -->
    <section id="sec-list" class="section">
      <div class="topbar">
        <div class="avatar">
          <img src="https://images.unsplash.com/photo-1543852786-1cf6624b9987?auto=format&fit=crop&w=200&q=60" alt="ç†Šç†Š">
        </div>
        <div class="topinfo">
          <div class="pill-row">
            <div class="pill"><span>ğŸ”ï¸</span><strong>ç™¾å²³æ¸…å–®</strong></div>
            <div class="pill"><span class="dot"></span><strong id="progressText2">0 / 100</strong></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>å·²å¾æœï¼š<span id="progressSmall2">0 / 100</span></h3>
        <div class="progress-wrap">
          <div class="progress-bar" id="progressBar2"></div>
        </div>
        <div class="small">å‹¾é¸ã€Œå·²å¾æœã€æœƒè‡ªå‹•æ›´æ–°é€²åº¦ï¼Œä¸¦æ¯ 10 åº§è·³ç¥è³€å¡ã€‚</div>
      </div>

      <div class="list" id="mountList">
        <div class="small">è¼‰å…¥ä¸­â€¦</div>
      </div>
    </section>

    <!-- ===== æ—¥è¨˜ï¼ˆå ä½ï¼‰ ===== -->
    <section id="sec-diary" class="section">
      <div class="topbar">
        <div class="avatar">
          <img src="https://images.unsplash.com/photo-1543852786-1cf6624b9987?auto=format&fit=crop&w=200&q=60" alt="ç†Šç†Š">
        </div>
        <div class="topinfo">
          <div class="pill-row">
            <div class="pill"><span>ğŸ“’</span><strong>æ—¥è¨˜</strong></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>å‹‡è€…æ—¥è¨˜ï¼ˆä¹‹å¾Œå¯ä»¥æ“´å……ï¼‰</h3>
        <div class="small">
          é€™é å…ˆä¿ç•™çµ¦ä½ ï¼šå¯ä»¥è¨˜éŒ„æ¯æ¬¡ç™»å±±çš„å¿ƒæƒ…ã€ç…§ç‰‡ã€è£å‚™æ¸…å–®ã€ä¸‹ä¸€æ¬¡ç›®æ¨™ç­‰ã€‚
        </div>
      </div>
    </section>

    <!-- ===== è¨­å®šï¼ˆå ä½ï¼‰ ===== -->
    <section id="sec-settings" class="section">
      <div class="topbar">
        <div class="avatar">
          <img src="https://images.unsplash.com/photo-1543852786-1cf6624b9987?auto=format&fit=crop&w=200&q=60" alt="ç†Šç†Š">
        </div>
        <div class="topinfo">
          <div class="pill-row">
            <div class="pill"><span>âš™ï¸</span><strong>è¨­å®š</strong></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>è³‡æ–™ç®¡ç†</h3>
        <div class="btn-row">
          <button id="btnReset" class="btn-ghost">ğŸ§¹ æ¸…ç©ºå¾æœ/ç´€éŒ„</button>
          <button id="btnTestCongrats" class="btn">ğŸ‰ æ¸¬è©¦ç¥è³€å¡</button>
        </div>
        <div class="small" style="margin-top:10px;">
          æ¸…ç©ºæœƒåˆªé™¤æœ¬æ©Ÿ localStorage çš„å¾æœç´€éŒ„èˆ‡æŠ½å¡ç´€éŒ„ã€‚
        </div>
      </div>
    </section>

  </div>

  <!-- ===== Bottom Nav ===== -->
  <div class="bottom-nav">
    <div class="nav-inner">
      <button class="navbtn active" data-go="draw"><div class="ico">ğŸ´</div><div>æŠ½å±±</div></button>
      <button class="navbtn" data-go="list"><div class="ico">â›°ï¸</div><div>ç™¾å²³</div></button>
      <button class="navbtn" data-go="diary"><div class="ico">ğŸ“’</div><div>æ—¥è¨˜</div></button>
      <button class="navbtn" data-go="settings"><div class="ico">âš™ï¸</div><div>è¨­å®š</div></button>
    </div>
  </div>

  <!-- ===== Toast ===== -->
  <div class="toast" id="toast"></div>

  <!-- ===== Congrats Modal ===== -->
  <div class="modal-backdrop" id="congratsBackdrop">
    <div class="modal">
      <div class="modal-head">
        <div class="title">ğŸ‰ ç‰¹åˆ¥ç¥è³€å¡ï¼šå·²å¾æœ <span id="congratsCount">0</span> åº§ï¼</div>
        <button class="close" id="btnCloseCongrats">é—œé–‰</button>
      </div>
      <div class="modal-body">
        <!-- é€™å€‹å€å¡Šæœƒè¢«åŒ¯å‡ºæˆ PNG -->
        <div id="congratsCard" class="export-card">
          <h2>ä½ å¤ªçŒ›äº†ï¼å·²å®Œæˆ <span id="congratsProgress">0</span> / 100</h2>
          <div class="quote" id="congratsQuote">ğŸ» ç†Šç†Šèªªï¼šæ¯ä¸€æ­¥éƒ½ç®—æ•¸ã€‚ä½ ä¸æ˜¯åœ¨è·Ÿåˆ¥äººæ¯”ï¼Œä½ æ˜¯åœ¨è¶…è¶Šæ˜¨å¤©çš„è‡ªå·±ã€‚</div>
          <div class="line"></div>
          <div class="goal">âœ… ä¸‹ä¸€å€‹ç›®æ¨™ï¼š<span id="congratsGoal">10</span> åº§ï¼ˆå†è§£é–ä¸€å¼µç¥è³€å¡ï¼‰</div>
          <div class="ig">ğŸ“· IG <span style="font-weight:900;">@luckygbear</span></div>
        </div>

        <div class="btn-row" style="margin-top:12px;">
          <button id="btnExportCongratsPng" class="btn">ğŸ“¤ åŒ¯å‡ºé€™å¼µç¥è³€åœ–</button>
          <button id="btnLater" class="btn-ghost">ç¨å¾Œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== History Modal ===== -->
  <div class="modal-backdrop" id="historyBackdrop">
    <div class="modal">
      <div class="modal-head">
        <div class="title">ğŸ“œ æŠ½å¡ç´€éŒ„</div>
        <button class="close" id="btnCloseHistory">é—œé–‰</button>
      </div>
      <div class="modal-body">
        <div class="history-box" id="historyBox"></div>
      </div>
    </div>
  </div>

  <!-- html2canvas for export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    // =============== Storage Keys ===============
    const KEY_DONE = "bear100_done_ids";
    const KEY_HISTORY = "bear100_draw_history";
    const KEY_LAST_CONGRATS = "bear100_last_congrats"; // ä¸Šæ¬¡ç¥è³€é–€æª»ï¼ˆ10,20,30...ï¼‰

    // =============== Utilities ===============
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function getDoneSet(){
      const raw = localStorage.getItem(KEY_DONE);
      try{
        const arr = raw ? JSON.parse(raw) : [];
        return new Set(arr.map(Number));
      }catch{
        return new Set();
      }
    }
    function saveDoneSet(set){
      localStorage.setItem(KEY_DONE, JSON.stringify(Array.from(set)));
    }

    function getHistory(){
      const raw = localStorage.getItem(KEY_HISTORY);
      try{
        return raw ? JSON.parse(raw) : [];
      }catch{
        return [];
      }
    }
    function saveHistory(list){
      localStorage.setItem(KEY_HISTORY, JSON.stringify(list));
    }

    function toast(msg){
      const el = $("#toast");
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> el.style.display="none", 1800);
    }

    function formatMountain(m){
      return `${m.name_zh}ï¼ˆ${m.elevation_m}mï½œ${m.name_en}ï¼‰`;
    }

    async function downloadPng(el, filename){
      if(!el){
        alert("æ‰¾ä¸åˆ°è¦åŒ¯å‡ºçš„å¡ç‰‡å€å¡Šï¼ˆè«‹ç¢ºèª idï¼‰");
        return;
      }
      try{
        const canvas = await html2canvas(el, {
          scale: 2,
          backgroundColor: null,
          useCORS: true
        });
        const a = document.createElement("a");
        a.href = canvas.toDataURL("image/png");
        a.download = filename;
        a.click();
      }catch(e){
        console.error(e);
        alert("åŒ¯å‡ºå¤±æ•—ï¼šè«‹æ‰“é–‹ç€è¦½å™¨ Console çœ‹éŒ¯èª¤è¨Šæ¯");
      }
    }

    // é•·æŒ‰è¤‡è£½ bubble å°èªï¼ˆiOS ä¹Ÿå¯ç”¨ï¼‰
    function enableLongPressCopy(el, getTextFn){
      let timer = null;
      const start = () => {
        timer = setTimeout(async ()=>{
          const text = getTextFn();
          try{
            await navigator.clipboard.writeText(text);
            toast("å·²è¤‡è£½ âœ…");
          }catch{
            // fallback
            const ta = document.createElement("textarea");
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            ta.remove();
            toast("å·²è¤‡è£½ âœ…");
          }
        }, 600);
      };
      const cancel = () => { if(timer) clearTimeout(timer); timer=null; };

      el.addEventListener("touchstart", start, {passive:true});
      el.addEventListener("touchend", cancel);
      el.addEventListener("touchmove", cancel);

      el.addEventListener("mousedown", start);
      el.addEventListener("mouseup", cancel);
      el.addEventListener("mouseleave", cancel);
    }

    // =============== Data ===============
    let MOUNTAINS = [];

    async function loadMountains(){
      // æœŸå¾…ä½ æ”¾ ./mountains.jsonï¼ˆå°±æ˜¯ä½ è²¼çš„é‚£ä»½ï¼‰
      try{
        const res = await fetch("./mountains.json", { cache: "no-store" });
        if(!res.ok) throw new Error("fetch failed");
        const data = await res.json();
        if(!data || !Array.isArray(data.mountains)) throw new Error("invalid json");
        MOUNTAINS = data.mountains;
      }catch(e){
        console.warn("mountains.json load failed, use fallback", e);
        // fallback æœ€å°‘ç¤ºä¾‹ï¼Œé¿å…æ•´é å£æ‰
        MOUNTAINS = [
          {id:1,name_zh:"ç‰å±±",name_en:"Yushan",elevation_m:3952,difficulty:"advanced",difficulty_zh:"å»ºè­°å¸¶éšŠ",
            bear_story:"ğŸ» ç†Šç†Šèªªï¼šçœŸæ­£çš„å‹‡æ•¢ï¼Œæ˜¯çŸ¥é“ä»€éº¼æ™‚å€™è©²æ’¤é€€ï¼Œä»€éº¼æ™‚å€™å†ä¾†ã€‚",
            bear_advice:"âœ… é‡æ¿ƒéœ§/å¼·é¢¨/è½çŸ³é¢¨éšªä¸Šå‡æ™‚ï¼Œå„ªå…ˆæ’¤é€€ä¸çŒ¶è±«ã€‚",
            risk_note:"âš ï¸ æ›éšª/è¿·é€”/è½çŸ³é¢¨éšªè¼ƒé«˜ï¼›å»ºè­°è·ŸéšŠä¸¦ç¢ºå¯¦åšè¡Œç¨‹æ§ç®¡ã€‚"
          }
        ];
      }
    }

    // =============== UI Rendering ===============
    function updateProgressUI(){
      const done = getDoneSet();
      const count = done.size;
      const total = 100;

      $("#progressText").textContent = `${count} / ${total}`;
      $("#progressSmall").textContent = `${count} / ${total}`;
      $("#progressBar").style.width = `${Math.min(100, (count/total)*100)}%`;

      $("#progressText2").textContent = `${count} / ${total}`;
      $("#progressSmall2").textContent = `${count} / ${total}`;
      $("#progressBar2").style.width = `${Math.min(100, (count/total)*100)}%`;
    }

    function renderList(){
      const box = $("#mountList");
      const done = getDoneSet();

      box.innerHTML = "";

      MOUNTAINS
        .slice()
        .sort((a,b)=> b.elevation_m - a.elevation_m)
        .forEach(m=>{
          const row = document.createElement("div");
          row.className = "mount-item";

          const left = document.createElement("div");
          left.className = "left";

          const info = document.createElement("div");
          info.style.minWidth="0";

          const name = document.createElement("div");
          name.className = "name";
          name.textContent = m.name_zh;

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `æµ·æ‹” ${m.elevation_m}mï½œ${m.name_en}`;

          info.appendChild(name);
          info.appendChild(meta);

          const tag = document.createElement("div");
          tag.className = "tag";
          tag.textContent = (m.difficulty_zh || "");

          left.appendChild(info);
          left.appendChild(tag);

          const right = document.createElement("label");
          right.className = "done";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = done.has(Number(m.id));
          const txt = document.createElement("span");
          txt.textContent = "å·²å¾æœ";
          right.appendChild(cb);
          right.appendChild(txt);

          cb.addEventListener("change", ()=>{
            const set = getDoneSet();
            const id = Number(m.id);
            if(cb.checked) set.add(id);
            else set.delete(id);

            saveDoneSet(set);
            updateProgressUI();
            maybeCongrats(set.size);
          });

          row.appendChild(left);
          row.appendChild(right);

          box.appendChild(row);
        });
    }

    // =============== Congrats Logic ===============
    const congratsQuotes = [
      "ğŸ» ç†Šç†Šèªªï¼šæ¯ä¸€æ­¥éƒ½ç®—æ•¸ã€‚ä½ ä¸æ˜¯åœ¨è·Ÿåˆ¥äººæ¯”ï¼Œä½ æ˜¯åœ¨è¶…è¶Šæ˜¨å¤©çš„è‡ªå·±ã€‚",
      "ğŸ» ç†Šç†Šèªªï¼šä½ ä¸éœ€è¦è­‰æ˜ä»€éº¼ã€‚å¹³å®‰å›ä¾†ï¼Œå°±æ˜¯æ»¿åˆ†ã€‚",
      "ğŸ» ç†Šç†Šèªªï¼šæ…¢æ…¢èµ°ä¹Ÿæ²’é—œä¿‚ï¼Œèƒ½æŒçºŒå‰é€²çš„äººæœ€å¼·ã€‚",
      "ğŸ» ç†Šç†Šèªªï¼šçœŸæ­£çš„å‹‡æ•¢ï¼Œæ˜¯æ‡‚å¾—æ’¤é€€ï¼Œä¹Ÿæ˜¯æ‡‚å¾—å†å‡ºç™¼ã€‚",
      "ğŸ» ç†Šç†Šèªªï¼šç´¯äº†å°±å–æ°´ã€è£œèƒ½é‡ï¼Œå†åšæ±ºå®šã€‚ä½ å¾ˆæ£’ã€‚"
    ];

    function showCongrats(count){
      $("#congratsCount").textContent = count;
      $("#congratsProgress").textContent = count;

      const nextGoal = Math.min(100, Math.ceil((count+1)/10)*10);
      $("#congratsGoal").textContent = nextGoal;

      const quote = congratsQuotes[Math.floor(Math.random()*congratsQuotes.length)];
      $("#congratsQuote").textContent = quote;

      $("#congratsBackdrop").style.display = "flex";
    }

    function closeCongrats(){
      $("#congratsBackdrop").style.display = "none";
    }

    function maybeCongrats(count){
      // æ¯ 10 åº§è·³ä¸€æ¬¡ï¼š10,20,30...
      if(count <= 0) return;
      if(count % 10 !== 0) return;

      const last = Number(localStorage.getItem(KEY_LAST_CONGRATS) || "0");
      if(last === count) return;

      localStorage.setItem(KEY_LAST_CONGRATS, String(count));
      showCongrats(count);
    }

    // =============== Draw Logic ===============
    function pickRandomByDifficulty(diff){
      const collect = $("#collectMode").checked;
      const done = getDoneSet();

      let pool = MOUNTAINS.filter(m => m.difficulty === diff);
      if(collect){
        pool = pool.filter(m => !done.has(Number(m.id)));
      }
      if(pool.length === 0) return null;
      return pool[Math.floor(Math.random()*pool.length)];
    }

    function showDrawResult(m){
      const card = $("#drawResultCard");
      const text = $("#drawResultText");
      card.style.display = "block";

      const lines = [
        `ğŸ”ï¸ ${formatMountain(m)}`,
        ``,
        `${m.bear_story || "ğŸ» ç†Šç†Šèªªï¼šå‡ºç™¼å‰å…ˆæŠŠå®‰å…¨æª¢æŸ¥ä¸€éå–”ï¼"}`,
        `${m.bear_advice || ""}`,
        `${m.risk_note || ""}`
      ].filter(Boolean);

      text.textContent = lines.join("\n");
      text.style.whiteSpace = "pre-wrap";
    }

    function addHistory(m, modeLabel){
      const list = getHistory();
      list.unshift({
        t: new Date().toISOString(),
        mode: modeLabel,
        id: m.id,
        name_zh: m.name_zh,
        elevation_m: m.elevation_m,
        story: m.bear_story || "",
        advice: m.bear_advice || "",
        risk: m.risk_note || ""
      });
      // æ§åˆ¶ä¸è¦å¤ªå¤§
      saveHistory(list.slice(0, 80));
    }

    function openHistoryModal(){
      const box = $("#historyBox");
      const list = getHistory();

      if(list.length === 0){
        box.innerHTML = `<div class="small">ç›®å‰æ²’æœ‰ç´€éŒ„ï½å¿«å»æŠ½ä¸€å¼µ ğŸ´</div>`;
      }else{
        box.innerHTML = "";
        list.slice(0, 30).forEach(item=>{
          const d = new Date(item.t);
          const row = document.createElement("div");
          row.className = "h-item";

          const ht = document.createElement("div");
          ht.className = "ht";
          ht.textContent = `ğŸ´ ${item.name_zh}ï¼ˆ${item.elevation_m}mï¼‰ï½œ${item.mode}`;

          const hs = document.createElement("div");
          hs.className = "hs";
          hs.textContent = [
            item.story,
            item.advice,
            item.risk,
            `æ™‚é–“ï¼š${d.toLocaleString()}`
          ].filter(Boolean).join("\n");

          row.appendChild(ht);
          row.appendChild(hs);
          box.appendChild(row);
        });
      }

      $("#historyBackdrop").style.display = "flex";
    }

    function closeHistoryModal(){
      $("#historyBackdrop").style.display = "none";
    }

    // =============== Navigation ===============
    function go(section){
      const map = {
        draw: "#sec-draw",
        list: "#sec-list",
        diary: "#sec-diary",
        settings: "#sec-settings"
      };
      $$(".section").forEach(s=> s.classList.remove("active"));
      $(map[section]).classList.add("active");

      $$(".navbtn").forEach(b=> b.classList.remove("active"));
      $(`.navbtn[data-go="${section}"]`).classList.add("active");

      // é€²ç™¾å²³é å°±åˆ·æ–°æ¸…å–®ï¼ˆé¿å…ç‹€æ…‹ä¸åŒæ­¥ï¼‰
      if(section === "list"){
        renderList();
        updateProgressUI();
      }
    }

    // =============== Main ===============
    document.addEventListener("DOMContentLoaded", async () => {
      await loadMountains();
      updateProgressUI();
      renderList();

      // bubble é•·æŒ‰è¤‡è£½
      enableLongPressCopy($("#bubbleBox"), ()=> $("#bubbleText").textContent);

      // è·¯ç·šæŒ‰éˆ•
      $("#routeBeginner").addEventListener("click", ()=> {
        const m = pickRandomByDifficulty("beginner");
        if(!m){ toast("æ–°æ‰‹è·¯ç·šå·²æŠ½å®Œï¼ˆé›†å¡æ¨¡å¼ï¼‰âœ…"); return; }
        showDrawResult(m);
        addHistory(m, "æ–°æ‰‹ç™¾å²³");
      });

      $("#routeIntermediate").addEventListener("click", ()=> {
        const m = pickRandomByDifficulty("intermediate");
        if(!m){ toast("é€²éšè·¯ç·šå·²æŠ½å®Œï¼ˆé›†å¡æ¨¡å¼ï¼‰âœ…"); return; }
        showDrawResult(m);
        addHistory(m, "é€²éšæŒ‘æˆ°");
      });

      $("#routeAdvanced").addEventListener("click", ()=> {
        const m = pickRandomByDifficulty("advanced");
        if(!m){ toast("éœ€å¸¶éšŠè·¯ç·šå·²æŠ½å®Œï¼ˆé›†å¡æ¨¡å¼ï¼‰âœ…"); return; }
        showDrawResult(m);
        addHistory(m, "éœ€å¸¶éšŠæé†’");
      });

      // ç«‹å³æŠ½
      $("#btnDrawNow").addEventListener("click", ()=>{
        // æ··åˆæŠ½ï¼šå„ªå…ˆå¾æœªå¾æœçš„ä»»ä¸€é›£åº¦æŠ½
        const collect = $("#collectMode").checked;
        const done = getDoneSet();
        let pool = MOUNTAINS.slice();
        if(collect) pool = pool.filter(m => !done.has(Number(m.id)));
        if(pool.length === 0){ toast("å…¨éƒ¨éƒ½å¾æœ/æŠ½å®Œäº†ï¼ä½ æ˜¯å‚³èªª ğŸ†"); return; }
        const m = pool[Math.floor(Math.random()*pool.length)];
        showDrawResult(m);
        addHistory(m, "éš¨æ©ŸæŠ½å¡");
      });

      // æŠ½å¡ç´€éŒ„
      $("#btnHistory").addEventListener("click", openHistoryModal);
      $("#btnCloseHistory").addEventListener("click", closeHistoryModal);
      $("#historyBackdrop").addEventListener("click", (e)=> { if(e.target.id==="historyBackdrop") closeHistoryModal(); });

      // ç¥è³€å¡æ§åˆ¶
      $("#btnCloseCongrats").addEventListener("click", closeCongrats);
      $("#btnLater").addEventListener("click", closeCongrats);
      $("#congratsBackdrop").addEventListener("click", (e)=> { if(e.target.id==="congratsBackdrop") closeCongrats(); });

      // åŒ¯å‡ºï¼šä¸»é æŒ‰éˆ• -> åŒ¯å‡ºç¥è³€å¡ï¼ˆè‹¥æ²’é–‹ç¥è³€å¡ä¹Ÿå¯ä»¥åŒ¯å‡ºã€Œæœ€è¿‘ä¸€æ¬¡ç¥è³€å…§å®¹ã€ï¼‰
      $("#btnExport").addEventListener("click", async ()=>{
        // è‹¥ç¥è³€å¡æ²’é–‹ï¼Œå…ˆç”¨ç›®å‰é€²åº¦ç”Ÿæˆä¸€æ¬¡ï¼ˆä¸ä¸€å®šè¦æ•´åï¼‰
        const count = getDoneSet().size;
        $("#congratsCount").textContent = count;
        $("#congratsProgress").textContent = count;
        $("#congratsGoal").textContent = Math.min(100, Math.ceil((count+1)/10)*10);
        $("#congratsQuote").textContent = congratsQuotes[Math.floor(Math.random()*congratsQuotes.length)];
        await downloadPng($("#congratsCard"), "luckygbear-congrats.png");
        toast("å·²åŒ¯å‡ºç¥è³€åœ– âœ…");
      });

      // åŒ¯å‡ºï¼šæŠ½å¡åœ–ï¼ˆæŠŠæŠ½å¡çµæœå¡ç‰‡æˆªåœ–ï¼‰
      $("#btnExportCard").addEventListener("click", async ()=>{
        const el = $("#drawResultCard");
        if(el.style.display === "none"){
          toast("å…ˆæŠ½ä¸€å¼µæ‰å¯ä»¥åŒ¯å‡ºå–” ğŸ´");
          return;
        }
        await downloadPng(el, "luckygbear-draw.png");
        toast("å·²åŒ¯å‡ºæŠ½å¡åœ– âœ…");
      });

      // ç¥è³€å¡å…§åŒ¯å‡º
      $("#btnExportCongratsPng").addEventListener("click", async ()=>{
        await downloadPng($("#congratsCard"), "luckygbear-congrats.png");
        toast("å·²åŒ¯å‡ºç¥è³€åœ– âœ…");
      });

      // è¨­å®šï¼šæ¸…ç©º
      $("#btnReset").addEventListener("click", ()=>{
        if(!confirm("ç¢ºå®šæ¸…ç©ºå¾æœ/æŠ½å¡ç´€éŒ„å—ï¼Ÿ")) return;
        localStorage.removeItem(KEY_DONE);
        localStorage.removeItem(KEY_HISTORY);
        localStorage.removeItem(KEY_LAST_CONGRATS);
        updateProgressUI();
        renderList();
        toast("å·²æ¸…ç©º âœ…");
      });

      // è¨­å®šï¼šæ¸¬è©¦ç¥è³€å¡
      $("#btnTestCongrats").addEventListener("click", ()=>{
        showCongrats(getDoneSet().size || 0);
      });

      // Bottom nav
      $$(".navbtn").forEach(btn=>{
        btn.addEventListener("click", ()=> go(btn.dataset.go));
      });
    });
  </script>
</body>
</html>